# クライアント認証モジュール 詳細仕様書

## 1. 概要

本仕様は、React + TypeScript で構築されたクライアント認証機構の詳細を示す。
`Auth.tsx` にログインフォームと認証ロジックを統合し、Recoil で状態管理、MUI で UI 表示を行う。

## 2. フォルダ構成

```
src/
├─ apps/
│   └─ Auth/
│       ├─ Auth.tsx          // UI + 認証処理統合コンポーネント
│       └─ hooks/
│           └─ useAuth.ts    // 認証処理ロジック
├─ store/
│   ├─ atom/
│   │   └─ authAtoms.ts      // JWT, clientIdなどのグローバル状態
│   ├─ selector/
│   │   └─ authSelectors.ts  // 認証状態判定などのセレクタ
|   └─ api/
│       └─ authApi.ts        // 認証関連のAPI呼び出し
```

## 3. Auth.tsx（統合コンポーネント）

### 3.1 機能

1. パスワード入力フォームの表示
2. ログインボタン押下で `useAuth.login` 呼び出し
3. ログイン中は `loading` フラグでボタン状態制御
4. ログイン失敗時は `error` メッセージ表示
5. JWT を Recoil の `jwtState` に保存
6. `isAuthenticatedState` でログイン済み判定
7. Enter キーでフォーム送信
8. UI フォームは MUI コンポーネントで統一
9. ログイン成功時はHome機能に遷移、ManagementAPを起動

### 3.2 UI構造

| 要素         | 型   | 用途         |
| ---------- | --- | ---------- |
| TextField  | MUI | パスワード入力    |
| Button     | MUI | ログイン実行     |
| Typography | MUI | エラーメッセージ表示 |
| Box        | MUI | フォームレイアウト  |

### 3.3 ステート管理

```ts
```

### 3.4 イベント処理

```ts
```

## 4. useAuth.ts（認証ロジック）

### 4.1 提供メソッド

| メソッド           | 引数               | 戻り値             | 説明                                       |
| -------------- | ---------------- | --------------- | ---------------------------------------- |
| login          | password: string | Promise<void>   | クライアントID取得 → チャレンジ取得 → パスワードハッシュ → JWT取得 |
| logout         | なし               | void            | JWT削除                                    |
| fetchClientId  | なし               | Promise<string> | サーバーからクライアントID取得                         |
| fetchChallenge | clientId: string | Promise<string> | サーバーからチャレンジ取得                            |


## 5. Recoil状態管理

### 5.1 authAtoms.ts

| atom名         | 型              | 用途         |
| ------------- | -------------- | ---------- |
| clientIdState | string \| null | クライアントID保持 |
| jwtState      | string \| null | JWT保持      |

### 5.2 authSelectors.ts

| selector名            | 型       | 説明           |
| -------------------- | ------- | ------------ |
| isAuthenticatedState | boolean | JWT が存在するか判定 |


## 6. API仕様（authApi.ts）

| 関数名          | 引数                                     | 戻り値             | 説明               |
| ------------ | -------------------------------------- | --------------- | ---------------- |
| getClientId  | なし                                     | Promise<string> | サーバーからクライアントID取得 |
| getChallenge | clientId: string                       | Promise<string> | サーバーからチャレンジ取得    |
| loginRequest | clientId: string, passwordHash: string | Promise<string> | JWT取得            |


## 7. 認証フロー

```
Auth.tsx (UI + フォーム)
      ↓ handleSubmit
useAuth.login(password)
      ↓ fetchClientId -> fetchChallenge -> loginRequest
jwtState 更新
      ↓
isAuthenticatedState 更新 → ログイン済み画面表示
```

## 8. 実装規約

* ローカルステートはフォーム入力専用
* Recoil で JWT や clientId を管理
* selectorを活用し、Apiステートレスな実装を徹底する。
* Apiユーティリティを定義し、axiosを使用して可読性・可用性を担保する。
* async/await で非同期制御
* MUI +Styled Componentによりコンポーネントファイルの可読性を担保
* JWTリフレッシュや多要素認証の追加余地を残す
* Enter キーで送信可能
* カスタムフックを用いてコンポーネントとロジック層は分離するものとする。
* ルートでは極力 constでの定義は避け、functionで定義する。
* 関数内ではfunctionの定義は避け、const+useCallback/useMemoで定義する。

## 9. セキュリティ・制約

1. パスワード非表示（type="password"）2
2. JWT 保存: Recoil または必要に応じてセッションストレージ
3. クライアント側でチャレンジとパスワードを SHA-256 ハッシュ化
4. 自動リトライは最大3回
5. パスワード長・文字種はバックエンド仕様に準拠
